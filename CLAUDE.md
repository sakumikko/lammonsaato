# Claude Context - Pool Heating Automation Project

**Last Updated:** 2025-11-30
**Project:** lammonsaato (Pool Heating Optimizer for Home Assistant)

## Project Overview

Home Assistant automation system that:
1. Fetches Nordpool electricity prices (15-minute intervals) for Finland
2. Calculates optimal heating schedule: 2 hours total, 30-45 min blocks with equal breaks
3. Controls pool heating via two Shelly switches
4. Reads Thermia Mega heat pump sensors via Modbus TCP
5. Calculates energy usage and costs based on delta-T, flow rate, and COP
6. Logs heating sessions locally (Firebase was dropped due to auth issues)

## Project Structure

**IMPORTANT:** All source files are in the main directories. The `dist/` folder is generated by `make build` and should NOT be edited directly.

```
lammonsaato/
├── docs/                           # SOURCE: Documentation (version controlled)
│   ├── PROJECT_PLAN.md             # Full architecture & implementation plan
│   ├── SETUP_GUIDE.md              # Step-by-step HA installation guide
│   ├── TESTING_PLAN.md             # Testing strategy
│   ├── THERMIA_REGISTERS.md        # Modbus register reference
│   └── TROUBLESHOOTING.md          # Common issues and solutions
│
├── homeassistant/                  # SOURCE: Home Assistant configuration
│   ├── packages/
│   │   └── pool_heating.yaml       # Complete HA package (inputs, sensors, automations)
│   └── lovelace/
│       └── pool_heating_card.yaml  # Dashboard card configuration
│
├── scripts/                        # SOURCE: Python scripts
│   ├── pyscript/                   # Pyscript modules for Home Assistant
│   │   ├── pool_heating.py         # Price optimization & scheduling
│   │   └── firebase_sync.py        # Local data logging (renamed from firebase)
│   ├── standalone/                 # Test scripts for development
│   │   ├── test_thermia.py         # Thermia Modbus test
│   │   ├── test_nordpool.py        # Nordpool API test
│   │   ├── test_firebase.py        # Local logging test
│   │   ├── test_live_integration.py
│   │   ├── test_ha_automation.py
│   │   └── ha_client.py
│   └── build.py                    # Build script for dist
│
├── tests/                          # Unit tests
│   ├── conftest.py
│   ├── test_price_optimizer.py
│   └── test_ha_yaml.py
│
├── dist/                           # GENERATED: Do not edit! Created by `make build`
│   ├── packages/                   # Copied from homeassistant/packages/
│   ├── pyscript/                   # Copied from scripts/pyscript/
│   ├── docs/                       # Copied from docs/
│   └── README.md
│
├── findings/                       # Screenshots and debug files
├── secrets/                        # Secret files (gitignored)
├── env/                            # Python virtualenv (gitignored)
├── Makefile
├── requirements.txt
├── CLAUDE.md                       # This file - context for Claude
└── CLAUDE_SESSION_CONTEXT.md       # Legacy context file
```

## Key Configuration Values

| Setting | Value |
|---------|-------|
| Thermia Host | 192.168.50.10:502 (Modbus TCP) |
| Thermia Entry ID | ac1e4962ee893b58e6d2c1f95e4caeef |
| Nordpool Sensor | sensor.nordpool_kwh_fi_eur_3_10_0255 |
| Heating Window | 21:00 - 07:00 |
| Total Heating | 2 hours (120 minutes) |
| Block Duration | 30-45 minutes |
| Break Duration | Equal to preceding block |
| Flow Rate | 45 L/min |
| Assumed COP | 3.0 |

## Entity IDs

### Switches (Shelly)
- `switch.altaan_lammityksen_esto` - Heating prevention (OFF = allow heating)
- `switch.altaan_kiertovesipumppu` - Circulation pump (ON = heating)

### Sensors (Thermia Genesis Integration)
- `sensor.condenser_out_temperature` - Hot water TO pool
- `sensor.condenser_in_temperature` - Cool water FROM pool (returned)

Note: Other Thermia sensors (supply_temperature, outdoor_temperature, etc.) may exist but are not used by this project.

### Calculated Sensors
- `sensor.pool_heat_exchanger_delta_t` - Temperature difference
- `sensor.pool_thermal_power` - Heat delivered (kW)
- `sensor.pool_heating_electrical_power` - Electricity used (kW)
- `sensor.pool_heating_cost_rate` - Current cost (€/h)
- `sensor.pool_heating_electricity_daily` - Daily kWh (electrical)
- `sensor.pool_heating_cost_daily` - Daily cost €

## Known Issues & Workarounds

### 1. Thermia Integration Freezes
The `thermiagenesis` integration stops polling after idle time.
**Solution:** Automations in pool_heating.yaml:
- `thermia_hourly_reload` - Reloads integration every hour
- `thermia_stale_recovery` - Reloads if sensors stale >10 min

### 2. Pyscript Limitations
Pyscript doesn't support Python generator expressions.
**Solution:** Use explicit for loops instead of `sum(x for x in list)`

### 3. Nordpool Entity ID
Entity ID depends on your Nordpool configuration. If prices don't work:
1. Find actual ID in Developer Tools > States > search "nordpool"
2. Update in `scripts/pyscript/pool_heating.py` (NORDPOOL_SENSOR)
3. Update in `homeassistant/packages/pool_heating.yaml` (3 places)

### 4. Dashboard Integration Toggle
Auto-generated dashboards show toggle that can disable Thermia.
**Solution:** Take control of dashboard (Edit > Take control) and remove toggle

## Development Workflow

```bash
# Activate virtualenv
source env/bin/activate

# Run tests
make test              # Unit tests
make test-thermia      # Test Modbus connection
make test-nordpool     # Test price API

# Test templates (requires HA_URL and HA_TOKEN)
export HA_URL=http://homeassistant.local:8123
export HA_TOKEN=your_token
python scripts/standalone/test_templates.py

# Build distribution package
make build             # Creates dist/ folder

# Deploy to Home Assistant (via Samba)
# Copy dist/ contents to HA /config/ folder
```

## Template Testing Guidelines

**IMPORTANT:** When modifying Jinja2 templates in `pool_heating.yaml`, always update the corresponding test in `scripts/standalone/test_templates.py`.

The test script validates templates by rendering them via the Home Assistant API. This catches:
- Syntax errors
- Timezone issues (offset-naive vs offset-aware datetimes)
- Missing entities or attributes
- Logic errors

Templates in `test_templates.py` to keep in sync:
- `pool_next_heating` - Next scheduled heating block
- `pool_heating_block_count` - Number of active blocks
- `pool_in_heating_window` - Binary sensor for current heating window
- `pool_thermal_power` - Thermal power calculation
- `pool_heating_electrical_power` - Electrical power estimate
- `pool_heating_cost_rate` - Current cost rate

You can also test templates manually in Home Assistant at **Developer Tools → Template**.

## Files to Edit (Source Locations)

| What | Edit This | NOT This |
|------|-----------|----------|
| HA Package | homeassistant/packages/pool_heating.yaml | dist/packages/... |
| Pyscript | scripts/pyscript/pool_heating.py | dist/pyscript/... |
| Pyscript logging | scripts/pyscript/firebase_sync.py | dist/pyscript/... |
| Dashboard card | homeassistant/lovelace/pool_heating_card.yaml | - |
| Setup guide | docs/SETUP_GUIDE.md | dist/docs/... |
| Troubleshooting | docs/TROUBLESHOOTING.md | dist/docs/... |

## Documentation

- [Product Requirements](docs/PRODUCT_REQUIREMENTS.md) - What the system does and why
- [Technical Design](docs/TECHNICAL_DESIGN.md) - Architecture, components, entity reference
- [Setup Guide](docs/SETUP_GUIDE.md) - Step-by-step installation
- [Troubleshooting](docs/TROUBLESHOOTING.md) - Common issues and solutions
- [Thermia Registers](docs/THERMIA_REGISTERS.md) - Modbus register reference

## Recent Changes (2025-11-30)

1. Fixed pyscript NameError for missing pool temperature sensor
2. Added energy/cost calculation (delta-T × flow × COP)
3. Added Thermia auto-reload automations for stability
4. Made all logging calls `continue_on_error: true`
5. Added 24-hour time format instructions to setup guide
6. Updated Nordpool sensor ID to `sensor.nordpool_kwh_fi_eur_3_10_0255`
7. Power/energy sensors only calculate when pool heating is active
8. Fixed timezone issues in datetime templates
9. Restructured docs: PROJECT_PLAN.md → PRODUCT_REQUIREMENTS.md + TECHNICAL_DESIGN.md
10. Removed stale test files (test_thermia.py, test_nordpool.py)
